# Simplification Survey

1. **Files**: server/ai_executor.go
   - **Focus**: Waypoint index normalization for NPC behaviour helpers like `evaluateCondition`, `actionNavigate`, `actionFace`, and `actionSetWaypoint`.
   - **Proposal**: Extract a shared helper (e.g., `normalizeWaypointIndex(npc *npcState)`) that clamps/mods the blackboard index and returns the active waypoint, replacing the repeated `if idx < 0 { idx = 0 }` / modulo blocks scattered across the file.
   - **Why**: The identical guard/modulo sequence shows up in at least four functions and any future change to waypoint wrapping rules requires touching them all. Centralising it reduces duplication and makes it easier to reason about patrol behaviour tweaks.

2. **Files**: server/messages.go
   - **Focus**: `joinResponse`, `stateMessage`, and `keyframeMessage` structs duplicating the same snapshot fields (players, NPCs, obstacles, ground items, config).
   - **Proposal**: Introduce a shared struct or embed (e.g., `worldSnapshotPayload`) that owns the repeated slices/config fields, then compose it into each message type so protocol changes touch a single definition.
   - **Why**: Every time we add or rename a field we currently update three structs plus their JSON tags. Consolidating the shared shape reduces the risk of drift (especially between join vs. state payloads) and simplifies future schema evolution.

3. **Files**: client/network.js
   - **Focus**: The `isBloodSplatterSpawn`, `isFireSpawn`, `isAttackSpawn`, and similar helpers each walking the same nested candidate list just to swap out the identifier predicate.
   - **Proposal**: Collapse the repeated traversal into a single utility like `spawnMatches(spawn, matcher)` that gathers candidate strings once and checks them via a callback or lookup table.
   - **Why**: Each function duplicates ~40 lines of guard logic, making future schema tweaks (e.g., renamed keys) error-prone. A shared matcher trims hundreds of lines and keeps effect detection consistent across new visual types.

4. **Files**: server/hub.go
   - **Focus**: `broadcastState` scanning every payload for hard-coded substrings (`blood-splatter`, `fire`, etc.) before logging the entire JSON blob.
   - **Proposal**: Remove or gate this instrumentation behind a debug flag (or reuse existing telemetry) instead of running multiple `bytes.Contains` checks on every tick.
   - **Why**: The logging adds CPU work proportional to payload size and spams stdout with whole snapshots, yet it's only useful for ad-hoc debugging. Making it optional simplifies the hot path and reduces log noise during playtests.
