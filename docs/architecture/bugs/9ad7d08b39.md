# Potential Bugs

## 1. Ground item snapshot payloads dropped during regular ticks
- **File(s):** `server/hub.go`, `server/ground_items.go`
- **What it concerns:** `Hub.broadcastState` drops the `groundItems` slice whenever it isn't emitting a keyframe snapshot, even though callers like `HandleConsoleCommand` (for `pickup_gold` and `drop_gold`) and ground item pickups pass a freshly captured ground item snapshot to broadcast new stacks or removals.
- **Why it's a problem:** Non-keyframe updates zero out `groundItems`, so these broadcasts never reach clients until the next forced keyframe. New drops (which rely on snapshots instead of patches) and removals triggered by pickups vanish locally but remain visible to everyone else for an entire keyframe interval, causing duplicated or ghost stacks in the UI.

## 2. Player removals invisible until the next keyframe
- **File(s):** `server/hub.go`, `server/simulation.go`
- **What it concerns:** `World.Step` prunes timed-out players immediately, and `Hub.advance` hands the current player list to `Hub.broadcastState`. However, the broadcaster also nulls the `players` slice on non-keyframe ticks, so the removal never reaches other clients unless a keyframe happens soon after.
- **Why it's a problem:** When a player disconnects mid-interval (timeout or manual removal without forcing a keyframe), every other client keeps rendering that actor because neither a snapshot nor a removal patch is ever sent. The ghost sticks around until the next keyframe, at which point reconciliation finally removes it.

## 3. Equip swapping can drop gear & stats if reinsertion fails
- **File(s):** `server/world_equipment.go`
- **What it concerns:** When `EquipFromInventory` replaces an occupied slot, it immediately strips the old item's stat bonuses and calls `MutateEquipment`/`AddStack` to stash the unequipped item. Both calls ignore their returned errors.
- **Why it's a problem:** If `AddStack` fails (e.g., definition mismatch after balance tweaks) or the equipment mutation refuses to remove the old item, the function keeps going with the stats already cleared. The player loses the previous gear and never regains its bonuses, leaving their build permanently debuffed.

## 4. EquipFromInventory aborts after mutating state when stat delta lookup fails
- **File(s):** `server/world_equipment.go`, `server/equipment.go`
- **What it concerns:** After installing the new item, `EquipFromInventory` calls `equipmentDeltaForDefinition`. If that helper errors (missing definition ID, future validation, etc.), the function returns immediately.
- **Why it's a problem:** By that point the inventory has already lost one copy of the item, the equipment slot now references it, and the old gear (if any) is gone. Because the error path doesn't roll any of that back—or reapply the removed stat layer—the player winds up equipped with an item that contributes no stats, while also losing the inventory stack.
