# Bug Review Notes

## 1. Effect patches silently dropped in hub state marshaling
- **File(s):** `server/hub.go`
- **Issue:** When `marshalState` filters the `patches` slice, it only whitelists IDs for players, NPCs, and ground items. Patches emitted for effect instances (such as `PatchEffectPos`/`PatchEffectParams`) never make it into the outbound payload because effect IDs are absent from the `alive` map, so the filter discards them.
- **Why it matters:** The world writes effect diffs through `World.SetEffectPosition` and friends expecting clients to stay in sync between keyframes. Dropping those patches means projectile/effect state changes are completely hidden until a full snapshot, producing stale visuals and defeating the effect transport.

## 2. Ground item removals bypass the patch journal
- **File(s):** `server/ground_items.go`, `server/hub.go`
- **Issue:** `removeGroundItem` deletes stacks from the world maps without emitting a patch, and `broadcastState` throws away the ad-hoc `groundItems` snapshot whenever a keyframe isn’t due. When a player picks up gold we broadcast immediately, but the payload contains neither a diff nor the refreshed stack list, so clients keep rendering the removed stack until the next keyframe.
- **Why it matters:** Ground item pickup/drop feedback is critical. Because removals are invisible in diff messages, players see phantom loot and can repeatedly attempt pickups that always fail, and telemetry logs “not_found” errors until a keyframe clears the stale state.

## 3. Player removals never reach subscribers outside keyframes
- **File(s):** `server/hub.go`, `server/simulation.go`
- **Issue:** `World.RemovePlayer` simply deletes the entry, and `broadcastState` suppresses the players slice when it isn’t time for a keyframe. Disconnects and heartbeat timeouts therefore emit no diff describing that the actor vanished, so clients keep ghosts in their local roster until the next full snapshot.
- **Why it matters:** Ghost players break combat targeting and diagnostics. Systems that rely on the roster (UI, AI threat selection, telemetry) continue to believe the player exists, which can yield attacks against nonexistent entities and confusing HUD readouts until a keyframe lands.

## 4. Equipment patches are never applied on the client
- **File(s):** `server/world_equipment.go`, `client/patches.js`
- **Issue:** The server emits `player_equipment`/`npc_equipment` patches whenever equipment changes, but the client’s patch table only recognises movement, intent, health, inventory, and ground item kinds. Unsupported kinds trigger an error and are skipped, so equipment swaps from commands like `EquipFromInventory` never reach the HUD.
- **Why it matters:** Inventory and equipment panels become permanently out of sync after any gear change. Players see stale loadouts, stats don’t match, and resync attempts fail because the baseline never applied the queued equipment diffs.

