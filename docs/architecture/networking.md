# Networking Overview

Mine & Die uses a short HTTP preamble followed by a long-lived WebSocket for
real-time play. The Go server simulates the world at a fixed 15 Hz, records
patches, and publishes snapshots; the browser client streams player input,
keyframe control messages, and heartbeats while reconstructing state locally.
This document reflects the current implementation in `server/` and
`client/`.

## Connection Lifecycle

1. **Join handshake (`POST /join`)** – The server creates a new player ID,
   seeds world state, forces the next broadcast to be a keyframe, and returns
   the authoritative snapshot. The payload includes `ver`, the allocated `id`,
   arrays for `players`, `npcs`, `obstacles`, any `groundItems`, the normalized
   world `config`, `resync: true`, and the active `keyframeInterval`. The flow
   runs through `Hub.Join` and `hub.marshalState`. [server/hub.go](../../server/hub.go) [server/messages.go](../../server/messages.go)
2. **WebSocket upgrade (`GET /ws?id=…`)** – The browser opens a socket using the
   join response `id`. The `http.HandleFunc("/ws", …)` handler validates the ID,
   `Hub.Subscribe` registers the subscriber, and the server immediately writes a
   `state` message flagged with `resync: true` so late joiners start from the
   latest tick. [server/main.go](../../server/main.go) [server/hub.go](../../server/hub.go)
3. **Steady state** – `Hub.RunSimulation` advances the world at 15 ticks per
   second, drains player commands, and calls `broadcastState`. Patches are
   journaled every tick; full snapshots are emitted when
   `shouldIncludeSnapshot` decides the keyframe cadence (default interval ≥1 and
   adjustable at runtime). Every outbound message carries a monotonically
   increasing `sequence`, the current tick (`t`), and `keyframeSeq`. Clients
   append their latest acknowledged tick as `ack`; the server tracks it for
   diagnostics via `recordAck`. [server/constants.go](../../server/constants.go) [server/hub.go](../../server/hub.go) [client/network.js](../../client/network.js)

If the socket closes or the patch pipeline requests a resync, the client tears
down local state and schedules a fresh join after one second through
`scheduleReconnect`. [client/network.js](../../client/network.js)

## HTTP API Surface

| Endpoint | Method | Description |
| --- | --- | --- |
| `/health` | `GET` | Returns `ok` for container liveness checks. [server/main.go](../../server/main.go) |
| `/join` | `POST` | Allocates a player and responds with the snapshot described above. No request body is required. [server/main.go](../../server/main.go) |
| `/ws` | `GET` | Upgrades to the WebSocket stream when given a valid `id` query parameter. Unknown IDs receive a policy-violation close frame. [server/main.go](../../server/main.go) |
| `/world/reset` | `POST` | Accepts a JSON body toggling obstacles, gold mines, NPC composition, lava, counts, and `seed`. The hub normalizes the request, rebuilds the world, forces the next keyframe, broadcasts a fresh state, and echoes the new config. [server/main.go](../../server/main.go) |
| `/diagnostics` | `GET` | Emits `status`, `serverTime`, the current tick rate and heartbeat interval, per-player heartbeat/RTT/ack data, and aggregated telemetry (bytes sent, keyframe statistics, effect metrics, tick budget alarms, etc.). [server/main.go](../../server/main.go) [server/hub.go](../../server/hub.go) [server/telemetry.go](../../server/telemetry.go) |

## Server → Client Messages

| Type | Fields | Notes |
| --- | --- | --- |
| `state` | `ver`, `type`, `t`, `sequence`, `keyframeSeq`, `serverTime`, `config`, `keyframeInterval`, `patches`, optional `resync` flag, plus optional `players`, `npcs`, `obstacles`, `groundItems`, `effectTriggers`, `effect_spawned`, `effect_update`, `effect_ended`, `effect_seq_cursors`, and (legacy) `effects`. | Generated by `hub.marshalState` and streamed via `broadcastState`. Full snapshots embed entity arrays; patch-only ticks omit them to save bandwidth. Patches are filtered to entities that still exist. Effect lifecycle batches are only attached when the contract `EffectManager` and transport flags are enabled; they contain per-effect spawn/update/end envelopes plus cursor hints so clients can drop duplicates deterministically through `applyEffectLifecycleBatch`. [server/messages.go](../../server/messages.go) [server/hub.go](../../server/hub.go) [server/constants.go](../../server/constants.go) [client/network.js](../../client/network.js) [client/effect-lifecycle.js](../../client/effect-lifecycle.js) |
| `heartbeat` | `ver`, `type`, `serverTime`, `clientTime`, `rtt`. | Reply to a client heartbeat message, reporting the round-trip latency derived server-side. [server/messages.go](../../server/messages.go) [server/main.go](../../server/main.go) |
| `console_ack` | `ver`, `type`, `cmd`, `status`, optional `reason`, `qty`, `stackId`, `slot`. | Acknowledges debug console commands such as `drop_gold`, `pickup_gold`, `equip_slot`, and `unequip_slot`, including contextual metadata. [server/messages.go](../../server/messages.go) [server/hub.go](../../server/hub.go) |
| `keyframe` | `ver`, `type`, `sequence`, `t`, `players`, `npcs`, `obstacles`, `groundItems`, `config`. | Retrieved from the keyframe journal in response to client recovery requests. [server/messages.go](../../server/messages.go) [server/hub.go](../../server/hub.go) |
| `keyframeNack` | `ver`, `type`, `sequence`, `reason`. | Indicates a keyframe request was rate-limited or the frame expired. [server/messages.go](../../server/messages.go) [server/hub.go](../../server/hub.go) |

Legacy one-shot `effectTriggers` continue to ship alongside the unified
lifecycle batches; `processEffectTriggers` deduplicates them before dispatch. [client/network.js](../../client/network.js)

## Client → Server Messages

All payloads are JSON objects that include `ver` (protocol version 1) and, when
known, the latest applied tick as `ack` via `sendMessage`. [client/network.js](../../client/network.js)

| Type | Fields | Purpose |
| --- | --- | --- |
| `input` | `dx`, `dy`, `facing` | Movement vector and facing override; processed every tick. [server/messages.go](../../server/messages.go) [server/main.go](../../server/main.go) |
| `path` | `x`, `y` | Requests server-driven navigation toward the clamped world coordinate. [server/main.go](../../server/main.go) |
| `cancelPath` | _(none)_ | Cancels server pathing. [server/main.go](../../server/main.go) |
| `action` | `action` | Fires an ability; the hub currently accepts `attack` and `fireball`. [server/main.go](../../server/main.go) [server/hub.go](../../server/hub.go) |
| `heartbeat` | `sentAt` | Keeps the session alive and lets the server compute RTT. [server/main.go](../../server/main.go) [client/network.js](../../client/network.js) |
| `console` | `cmd`, optional `qty` | Drives debug commands for item drops, pickups, and equipment management. [server/messages.go](../../server/messages.go) [server/hub.go](../../server/hub.go) |
| `keyframeRequest` | `keyframeSeq`, optional `keyframeTick` | Asks for a cached keyframe; retries are rate limited server-side and orchestrated client-side with exponential backoff (200 ms base, max 2 s, three attempts) through `updateKeyframeRetryLoop`. [server/main.go](../../server/main.go) [server/hub.go](../../server/hub.go) [client/network.js](../../client/network.js) |
| `keyframeCadence` | `keyframeInterval` | Requests a new keyframe interval. The hub normalizes the value, updates the cadence, forces a keyframe, and logs the applied interval. [server/messages.go](../../server/messages.go) [server/main.go](../../server/main.go) [server/hub.go](../../server/hub.go) [client/network.js](../../client/network.js) |

## Patch, Snapshot, and Keyframe Pipeline

`hub.marshalState` drains or snapshots the patch journal, filters patches to
entities that still exist, and chooses when to embed full entity arrays based on
`shouldIncludeSnapshot`. When a snapshot is included, the hub records a new
keyframe in the rolling journal and updates `keyframeSeq`. The current cadence is
broadcast as `keyframeInterval` so clients can match server intent. [server/hub.go](../../server/hub.go)

The client keeps a `patchState` object that mirrors every `state`, `join`,
`keyframe`, or `keyframeNack` envelope. On errors or resync requests it stops the
retry loop, triggers a reconnect, and starts requesting keyframes using the
backoff schedule above. [client/network.js](../../client/network.js)

Players can adjust cadence at runtime with `keyframeCadence`; the server clamps
invalid intervals back to the default and forces the next broadcast to be a
keyframe. [server/hub.go](../../server/hub.go) [server/main.go](../../server/main.go)

## Effect Transport

The unified effect pipeline now runs unconditionally. Every state broadcast
streams `effect_spawned`, `effect_update`, and `effect_ended` arrays alongside
the main payload and tracks `effect_seq_cursors` to help clients discard stale
updates. [server/hub.go](../../server/hub.go)

Each event is strongly typed: spawns include the replicated `EffectInstance`,
updates carry delivery/behaviour state deltas, and ends record the terminal
reason. [server/effects_contract.go](../../server/effects_contract.go) The client funnels these through
`applyEffectLifecycleBatch`, merging them into local effect instances, and keeps
per-effect diagnostics. [client/network.js](../../client/network.js) [client/effect-lifecycle.js](../../client/effect-lifecycle.js)

Legacy `effectTriggers` remain enabled for visual one-shots; the client tracks a
processed-ID set to avoid duplicate playback. [client/network.js](../../client/network.js)

## Heartbeats, Timeouts, and Reconnects

The browser emits a heartbeat immediately after the socket opens and every
2,000 ms thereafter. Each message records `sentAt`; the server enqueues a
heartbeat command, calculates RTT (ignoring timestamps more than five seconds in
the past), and replies with a `heartbeat` envelope. [client/network.js](../../client/network.js) [server/hub.go](../../server/hub.go) [server/main.go](../../server/main.go)

Server-side player records keep the latest heartbeat time. The simulation loop
removes actors whose heartbeats are older than `disconnectAfter` (three missed
intervals, ~6 seconds) and logs the timeout. [server/constants.go](../../server/constants.go) [server/simulation.go](../../server/simulation.go)

On any disconnect the client clears movement, heartbeats, patch state, and
lifecycle caches before scheduling a reconnect one second later. [client/network.js](../../client/network.js)

## World Configuration Broadcasts

World toggles cover obstacles, gold mines, NPC counts (with explicit goblin/rat
splits), lava, dimensions, and the procedural `seed`. Configs are normalized on
every reset and included in both join and state payloads so the client can update
UI and movement bounds immediately. [server/world_config.go](../../server/world_config.go) [client/network.js](../../client/network.js)

## Diagnostics and Telemetry

`/diagnostics` exposes per-player heartbeat metadata (ID, last heartbeat, RTT,
latest `ack`) plus the snapshot of telemetry counters. These counters track bytes
and entities broadcast, keyframe request rates, effect lifecycle totals, trigger
queues, and tick budget overruns/alarms. This endpoint is the canonical source
for external dashboards and load testing instrumentation. [server/main.go](../../server/main.go) [server/hub.go](../../server/hub.go) [server/telemetry.go](../../server/telemetry.go)
